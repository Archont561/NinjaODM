[project]
name = "NinjaODM"
version = "0.1.0"
description = "NinjaODM GeoDjango Microservices Server"
authors = [{name = "Eryk Srebrny", email = "esrebrny@onet.eu"}]
requires-python = ">=3.13,<3.14"

# Pixi Configuration
[tool.pixi.project]
channels = ["conda-forge"]
platforms = ["linux-64", "win-64"]  # Removed win-64 due to Unix-specific commands

[tool.pixi.dependencies]
python = ">=3.13.7,<3.14"

[tool.pixi.target.linux.dependencies]
gunicorn = ">=23.0.0"

[tool.pixi.feature.django.dependencies]
django = ">=5.2.7,<6"
django-ninja = ">=1.4.3,<2"
dj-database-url = ">=2.1.0,<3"
pydantic = ">=2.11.9,<3"
pydantic-settings = ">=2.11.0,<3"
geojson-pydantic = ">=2.0.0,<3"
uvicorn = ">=0.37.0,<0.38"
django-cors-headers = ">=4.9.0,<5"

[tool.pixi.feature.django.pypi-dependencies]
django-tus = ">=0.5.0,<0.6"
django-ninja-extra = ">=0.30.1,<0.31"
django-ninja-jwt = ">=5.3.9,<6"

[tool.pixi.feature.geo-libs.dependencies]
proj = ">=9.7.0,<10"
gdal = ">=3.11.4,<4"
geos = ">=3.14.0,<4"

[tool.pixi.feature.geo-libs-dev.dependencies]
libspatialite = ">=5.1.0,<6"

[tool.pixi.feature.test.dependencies]
factory_boy = ">=3.3.3,<4"
faker = ">=37.8.0,<38"
pytest = ">=8.4.2,<9"
pytest-cov = ">=7.0.0,<8"
pytest-django = ">=4.11.1,<5"
pytest-watch = ">=4.1.0,<5"
tuspy = ">=1.1.0,<2"
coverage = ">=7.0.0,<8"

[tool.pixi.feature.test.pypi-dependencies]
pytest-factoryboy = ">=2.8.1,<3"

[tool.pixi.feature.static-code-analysis.pypi-dependencies]
prospector = ">=1.17.3,<2"
django-stubs = ">=5.2.5,<6"
pylint-django = ">=2.6.1,<3"
bandit = ">=1.8.6,<2"
black = ">=25.1.0,<26"
mypy = ">=1.0.0,<2"
isort = ">=5.0.0,<6"

[tool.pixi.feature.miscellaneous.dependencies]
httpie = ">=3.2.4,<4"
loguru = ">=0.7.3,<0.8"

[tool.pixi.environments]
prod = ["django", "geo-libs"]
dev = ["django", "geo-libs", "geo-libs-dev", "static-code-analysis", "test", "miscellaneous"]
test = ["django", "geo-libs", "static-code-analysis", "test"]

[tool.pixi.tasks."django:manage"]
description = "Run Django management command"
cmd = ["python", "./app/manage.py"]

[tool.pixi.tasks."django:admin"]
description = "Show Django Admin CLI"
cmd = ["django-admin"]

[tool.pixi.tasks."dev:run"]
description = "Run dev server with auto-reload"
cmd = ["pixi", "run", "django:manage", "runserver"]

[tool.pixi.tasks."dev:uvicorn"]
description = "Run development server with uvicorn"
args = [
  { arg = "host", default = "localhost" },
  { arg = "port", default = "8000" }
]
cmd = [
  "uvicorn",
  "app.config.asgi:application",
  "--reload",
  "--host", "{{ host }}",
  "--port", "{{ port }}"
]

# Production server
[tool.pixi.tasks.start]
description = "Run production server with gunicorn and uvicorn workers"
args = [
  { arg = "host", default = "0.0.0.0" },
  { arg = "port", default = "8000" },
  { arg = "workers", default = "4" }
]
cmd = [
  "sh", "-c",
  "if [ -z \"$DJANGO_SECRET_KEY\" ]; then echo 'Error: DJANGO_SECRET_KEY is not set'; exit 1; fi && gunicorn app.config.asgi:application -k uvicorn.workers.UvicornWorker --bind {{ host }}:{{ port }} --workers {{ workers }}"
]

# Docker
[tool.pixi.tasks."docker:build"]
description = "Build Docker image for specified environment"
args = [
  { arg = "env", default = "prod" }
]
cmd = [
  "docker",
  "build",
  "--build-arg", "ENVIRONMENT={{ env }}",
  "-t", "ninjaodm:{{ env }}",
  "."
]

[tool.pixi.tasks."docker:run"]
description = "Run Docker container for specified environment"
args = [
  { arg = "env", default = "prod" },
  { arg = "port", default = "8000" }
]
cmd = [
  "docker",
  "run",
  "-it",
  "--rm",
  "-p", "{{ port }}:{{ port }}",
  "ninjaodm:{{ env }}"
]

# Script tasks
[tool.pixi.tasks."scripts:test-entrypoint"]
description = "Test entrypoint script locally"
cmd = ["bash", "scripts/entrypoint.sh"]

[tool.pixi.tasks."scripts:test-healthcheck"]
description = "Test healthcheck script locally"
cmd = ["bash", "scripts/healthcheck.sh"]

[tool.pixi.tasks."scripts:validate"]
description = "Validate all scripts with shellcheck"
cmd = ["sh", "-c", "command -v shellcheck >/dev/null 2>&1 && shellcheck scripts/*.sh || echo 'shellcheck not installed'"]

# Docker Compose tasks
[tool.pixi.tasks."compose:up"]
description = "Start services with docker-compose"
args = [
  { arg = "env", default = "prod" }
]
cmd = ["docker-compose", "up", "-d"]
env = { ENVIRONMENT = "{{ env }}" }

[tool.pixi.tasks."compose:up:dev"]
description = "Start development services"
cmd = ["docker-compose", "up", "app-dev"]

[tool.pixi.tasks."compose:down"]
description = "Stop services"
cmd = ["docker-compose", "down"]

[tool.pixi.tasks."compose:logs"]
description = "Show service logs"
cmd = ["docker-compose", "logs", "-f"]

[tool.pixi.tasks."compose:ps"]
description = "Show running services"
cmd = ["docker-compose", "ps"]

[tool.pixi.tasks."compose:restart"]
description = "Restart services"
cmd = ["docker-compose", "restart"]

# Testing
[tool.pixi.tasks.test]
cmd = [
  "sh", "-c",
  "pytest tests/unit/ && pytest tests/integration/ && pytest tests/e2e/"
]
description = "Run all tests in order (unit → integration → e2e)"

[tool.pixi.tasks."test:watch"]
cmd = ["ptw", "--", "-vv"]
description = "Watch and run tests"

[tool.pixi.tasks."test:unit"]
cmd = ["pytest", "tests/unit/", "-v"]
description = "Run unit tests only"

[tool.pixi.tasks."test:integration"]
cmd = ["pytest", "tests/integration/", "-v"]
description = "Run integration tests only"

[tool.pixi.tasks."test:e2e"]
cmd = ["pytest", "tests/e2e/", "-v"]
description = "Run e2e tests only"

[tool.pixi.tasks."test:coverage"]
cmd = [
  "sh", "-c",
  "coverage run -m pytest tests/unit/ tests/integration/ tests/e2e/ && coverage report && coverage html"
]
description = "Run tests with coverage"

[tool.pixi.tasks."test:coverage:unit"]
cmd = [
  "sh", "-c",
  "coverage run -m pytest tests/unit/ && coverage report"
]
description = "Coverage for unit tests only"

[tool.pixi.tasks."test:coverage:report"]
cmd = ["coverage", "report"]
description = "Show coverage report"

[tool.pixi.tasks."test:coverage:html"]
cmd = ["coverage", "html"]
description = "Generate HTML coverage report"

[tool.pixi.tasks."test:clean"]
cmd = [
  "sh", "-c",
  "rm -rf .pytest_cache htmlcov .coverage && find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true"
]
description = "Clean test artifacts"

[tool.pixi.tasks."test:ci"]
cmd = [
  "sh", "-c",
  "pytest tests/unit/ -v --tb=short && pytest tests/integration/ -v --tb=short && pytest tests/e2e/ -v --tb=short"
]
description = "Run all tests sequentially (CI mode)"

# Code quality
[tool.pixi.tasks."code-quality:lint"]
cmd = ["prospector"]
description = "Run linting with prospector"

[tool.pixi.tasks."code-quality:bandit"]
cmd = ["bandit", "-r", "app"]
description = "Run security checks with bandit"

[tool.pixi.tasks."code-quality:format"]
cmd = ["black", "app", "tests"]
description = "Format code with black"

[tool.pixi.tasks."code-quality:format-check"]
cmd = ["black", "--check", "app", "tests"]
description = "Check code formatting with black"

[tool.pixi.tasks."code-quality:isort"]
cmd = ["isort", "app", "tests"]
description = "Sort imports with isort"

[tool.pixi.tasks."code-quality:isort-check"]
cmd = ["isort", "--check-only", "app", "tests"]
description = "Check import sorting with isort"

[tool.pixi.tasks."code-quality:typecheck"]
cmd = ["mypy", "app"]
description = "Run type checking with mypy"

[tool.pixi.tasks."code-quality:all"]
cmd = [
  "sh", "-c",
  "black --check app tests && isort --check-only app tests && mypy app && prospector && bandit -r app"
]
description = "Run all code quality checks"

# Utilities
[tool.pixi.tasks."utils:generate-secret"]
cmd = [
  "python",
  "-c",
  "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
]
description = "Generate a new Django secret key"

[tool.pixi.tasks."utils:req"]
description = "Send HTTP request to development server"
args = [
  { arg = "method", default = "GET" },
  { arg = "host", default = "localhost" },
  { arg = "port", default = "8000" },
  { arg = "path", default = "" }
]
cmd = ["http", "{{ method }}", "{{ host }}:{{ port }}/{{ path }}"]

[tool.pixi.tasks.clean]
cmd = [
  "sh", "-c",
  "rm -rf .pytest_cache htmlcov .coverage .mypy_cache .ruff_cache && find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true"
]
description = "Clean all artifacts and cache files"

# Tool Configurations
[tool.pytest.ini_options]
minversion = "6.0"
addopts = [
    "-ra",
    "--strict-markers",
    "--reuse-db",
    "-v",
]
DJANGO_SETTINGS_MODULE = "config.settings"
testpaths = ["tests"]
pythonpath = ["app"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
filterwarnings = [
    "ignore::DeprecationWarning:pydantic.*",
    "ignore:Support for class-based `config`:DeprecationWarning",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "unit: marks tests as unit tests",
    "integration: marks tests as integration tests",
    "e2e: marks tests as end-to-end tests",
]

[tool.pytest-watch]
directories = ["app", "tests"]
args = ["tests/"]
clear = true

[tool.coverage.run]
source = ["app"]
omit = [
    "*/migrations/*",
    "*/tests/*",
    "*/test_*.py",
    "*/__pycache__/*",
    "*/settings/*",
    "*/manage.py",
    "*/wsgi.py",
    "*/asgi.py",
    "*/apps.py",
    "*/admin.py",
]
branch = true
parallel = true

[tool.coverage.report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "if settings.DEBUG",
    "raise AssertionError",
    "raise NotImplementedError",
    "if 0:",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    'class .*\bProtocol$:',
    "@(abc\\.)?abstractmethod",
]

[tool.coverage.html]
directory = "htmlcov"

[tool.coverage.xml]
output = "coverage.xml"

[tool.pylint.messages_control]
disable = [
    "C0111",
    "C0103",
    "R0903",
    "R0801",
    "W0212",
]

[tool.pylint.django]
django-settings-module = "config.settings"
load-plugins = "pylint_django"

[tool.bandit]
exclude_dirs = ["tests", "*/migrations/*"]
skips = ["B101", "B601"]

[tool.black]
line-length = 88
target-version = ['py313']
include = '\.pyi?$'
exclude = '''
/(
    \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | dist
  | migrations
)/
'''

[tool.isort]
profile = "black"
line_length = 88
known_django = ["django"]
sections = ["FUTURE", "STDLIB", "DJANGO", "THIRDPARTY", "FIRSTPARTY", "LOCALFOLDER"]
skip_glob = ["*/migrations/*"]

[tool.mypy]
python_version = "3.13"
plugins = ["mypy_django_plugin.main"]
ignore_missing_imports = true
strict_optional = true
warn_return_any = true
warn_redundant_casts = true
warn_unused_ignores = true

[tool.django-stubs]
django_settings_module = "config.settings"
